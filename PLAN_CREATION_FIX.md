# Plan Creation Feature Fix - Documentation

## Overview
This document describes the fixes applied to the plan creation feature and calendar display system to resolve synchronization issues and improve user experience.

## Problems Fixed

### 1. Phantom Calendar Entries After Data Reset
**Problem:** After clearing app data or using guest profile, the calendar erroneously displayed a plan even though it reported no plans were active.

**Root Cause:** The `usePlanIntegration` hook automatically created a default plan when none existed, causing it to appear in the calendar.

**Solution:** Removed automatic plan creation from `usePlanIntegration`. Now `currentPlan` is properly `null` when no active plan exists.

**Files Changed:**
- `src/hooks/usePlanIntegration.js` - Removed lines 32-38 that auto-created default plan

### 2. Inconsistent Active Plan Handling
**Problem:** `setActivePlan()` handled plan IDs differently between guest mode and authenticated mode, and couldn't accept plan objects.

**Root Cause:** The function only accepted string IDs, but some callers were passing plan objects.

**Solution:** Updated `setActivePlan()` to accept both plan IDs (string) and plan objects, extracting the ID when needed.

**Files Changed:**
- `src/utils/storage.js` - Enhanced `setActivePlan()` function

### 3. Calendar Not Supporting Session-Based Plans
**Problem:** Calendar only worked with recurring weekly plans (days array), not session-based plans with explicit dates.

**Root Cause:** `getWorkoutForDay()` only checked `currentPlan.days` array.

**Solution:** Updated calendar to handle both:
- Session-based plans (plans.sessions array with explicit dates)
- Day-based plans (plans.days array with recurring weekly structure)

**Files Changed:**
- `src/components/Calendar/MonthCalendarView.jsx` - Enhanced `getWorkoutForDay()` function
- `src/components/WorkTabs/UpcomingWeekTab.jsx` - Enhanced `getNext7Days()` function

## Plan Types Supported

### Session-Based Plans
Generated by `generateWorkoutPlan()` from `workoutPlanGenerator.js`

Structure:
```javascript
{
  id: "plan_123",
  name: "My 30-Day Plan",
  sessions: [
    {
      id: "session_1",
      date: 1704844800000, // Unix timestamp
      type: "upper",
      status: "planned",
      exercises: [...],
      sessionData: null
    },
    // ... more sessions
  ]
}
```

### Day-Based Plans
Generated by `createWeeklyPlan()` from `sessionStorageSchema.js`

Structure:
```javascript
{
  planId: "plan_ppl_2024_01_01",
  planStyle: "ppl",
  days: [
    { dayIndex: 0, type: "rest" },      // Sunday
    { dayIndex: 1, type: "strength", subtype: "push" },  // Monday
    { dayIndex: 2, type: "strength", subtype: "pull" },  // Tuesday
    // ... 7 days total
  ]
}
```

## Verification Steps

### Test 1: No Plan Scenario
1. Open the app
2. If you have an active plan, go to Settings and clear app data
3. Navigate to the Work tab
4. **Expected:** Calendar should show only manually-logged workouts (if any), not a phantom plan

### Test 2: Create Session-Based Plan
1. Go to Work tab
2. Click "Create New Plan" or similar button
3. Use the Custom tab to generate a plan
4. Set duration to 7 days, 3 days per week
5. Create the plan
6. **Expected:** 
   - Calendar shows workout days as planned (blue/highlighted)
   - Upcoming Week shows next 7 days with correct workouts
   - Only the 3 training days should show workouts, rest days are empty

### Test 3: Guest Mode
1. Sign out (if authenticated)
2. Use the app as a guest
3. Create a workout plan
4. Go to Settings and clear app data
5. Return to Work tab
6. **Expected:** Calendar should be empty (no phantom plan)

### Test 4: Data Reset
1. Create and activate a workout plan
2. Log a few workouts
3. Go to Settings > Reset All Data
4. Return to Work tab
5. **Expected:** Calendar should be empty except for the backup recovery option

### Test 5: Plan Creation Workflows

#### Quick Start (Template-Based)
1. Go to plan creation dialog
2. Select "Quick Start" tab
3. Choose a pre-built template (e.g., "Upper/Lower Split")
4. Enter plan name and duration
5. Click Create
6. **Expected:**
   - Plan is created with sessions for each day of duration
   - Each session has specific date
   - Calendar immediately shows all planned workouts
   - If plan name contains "This Week", it's auto-activated

#### Custom (Auto-Generated)
1. Go to plan creation dialog
2. Select "Custom" tab
3. Set parameters (days per week, goal, experience level, duration)
4. Click Generate Plan
5. **Expected:**
   - Plan is generated with sessions spread across duration
   - Sessions respect training days per week
   - Exercises are populated for each session
   - Calendar shows all planned sessions

## Integration Points

### Components That Handle Plans
1. **MonthCalendarView** - Displays planned and completed workouts
2. **UpcomingWeekTab** - Shows next 7 days from plan
3. **usePlanIntegration** - Manages active plan state
4. **WorkTabs** - Receives plan from App.jsx
5. **QuickPlanSetup** - Creates new plans

### Data Flow
```
App.jsx
  ↓ uses usePlanIntegration()
  ↓ gets currentPlan (or null)
  ↓ passes to WorkTabs
  ↓ passes to UpcomingWeekTab
  ↓ passes to MonthCalendarView
```

### Storage Layer
- **Guest Mode:** Full plan object stored in `goodlift_guest_active_plan`
- **Authenticated:** Plan ID stored in `goodlift_active_plan`, plan object in `goodlift_workout_plans`
- **Firebase:** Plans synced to user document for authenticated users

## API Changes

### setActivePlan(planIdOrObject)
**Before:**
```javascript
await setActivePlan(planId); // Only accepted string ID
```

**After:**
```javascript
await setActivePlan(planId);           // Still works
await setActivePlan(planObject);       // Now also works
await setActivePlan(planObject.id);    // Also works
await setActivePlan(null);             // Clear active plan
```

### Calendar getWorkoutForDay(date)
**Before:**
```javascript
// Only handled plans.days array
if (!currentPlan || !currentPlan.days) return null;
const dayOfWeek = date.getDay();
return currentPlan.days[dayOfWeek] || null;
```

**After:**
```javascript
// Handles both sessions and days arrays
if (currentPlan.sessions) {
  // Find session for specific date
  return sessions.find(s => sameDay(s.date, date));
}
if (currentPlan.days) {
  // Get recurring day
  return currentPlan.days[date.getDay()];
}
return null;
```

## Future Enhancements

### Recommended
1. **Unified Plan Model:** Consider consolidating to a single plan model that uses sessions array for all plans
2. **Migration:** Migrate old day-based plans to session-based format
3. **Plan Templates:** Add more pre-built templates for common programs
4. **Session Editing:** Allow users to edit individual sessions in a plan
5. **Plan Preview:** Show calendar preview before creating plan

### Testing
1. Add unit tests for plan creation functions
2. Add integration tests for calendar display
3. Add E2E tests for complete workflows
4. Test data migration scenarios

## Breaking Changes
None. All changes are backward compatible with existing plans.

## Migration Notes
No data migration required. The system now handles both plan formats transparently.
